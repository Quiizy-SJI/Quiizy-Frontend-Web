import{a as C}from"./chunk-AJHYPDYV.js";import{a as Q}from"./chunk-5HN4BRYP.js";import{a as z}from"./chunk-YPRXJ25I.js";import{k as y}from"./chunk-LSE4QE4L.js";import{A as b,L as S,U as v,Z as m,l as h,q as D,w as f}from"./chunk-T26DWB6S.js";var T=class g{api=m(y);deanApi=m(z);teacherApi=m(Q);deanStatsCache$;deanAnalyticsCache$;getDeanDashboardInsights(e){return f({stats:this.getDeanStats(e?.academicYearId),analytics:this.getDeanAnalytics(e?.academicYearId)}).pipe(D(({stats:t,analytics:r})=>this.buildDeanDashboard(t,r,e)),b(t=>(console.error("Error loading dean dashboard:",t),h(this.getEmptyDeanDashboard()))))}getDeanStats(e){if(!e&&this.deanStatsCache$)return this.deanStatsCache$;let t=this.deanApi.getStats(e).pipe(S(1));return e||(this.deanStatsCache$=t),t}getDeanAnalytics(e){if(!e&&this.deanAnalyticsCache$)return this.deanAnalyticsCache$;let t=this.deanApi.getAiAnalytics(e).pipe(S(1));return e||(this.deanAnalyticsCache$=t),t}clearCache(){this.deanStatsCache$=void 0,this.deanAnalyticsCache$=void 0}getTeacherDashboardInsights(e){return f({courses:this.teacherApi.getMyCourses(),quizzes:this.teacherApi.getMyQuizzes()}).pipe(D(({courses:t,quizzes:r})=>this.buildTeacherDashboard(t,r,e)),b(t=>(console.error("Error loading teacher dashboard:",t),h(this.getEmptyTeacherDashboard()))))}buildDeanKpis(e){let t=e.participation.invited+e.participation.inProgress+e.participation.completed+e.participation.missed,r=t>0?e.participation.completed/t*100:0,i=t-e.participation.completed,o=e.totals.students>0?Math.min(100,i/t*100):0;return[{title:"Total Students",metric:{value:e.totals.students,label:"Enrolled Students",unit:"students"},icon:"school",color:"primary",description:"Active student enrollments"},{title:"Total Teachers",metric:{value:e.totals.teachers,label:"Teaching Staff",unit:"teachers"},icon:"person",color:"info",description:"Registered teachers"},{title:"Quizzes Created",metric:{value:e.totals.quizzes,label:"Total Quizzes",unit:"quizzes"},icon:"assignment",color:"success",description:"Assessments available"},{title:"Average Score",metric:{value:e.scores.averagePercent??0,label:"Overall Performance",unit:"%",trend:this.computeTrend(e.scores.averagePercent??0,70)},icon:"trending_up",color:this.getScoreColor(e.scores.averagePercent??0),description:"Institution average"},{title:"Completion Rate",metric:{value:r,label:"Quiz Completion",unit:"%",trend:this.computeTrend(r,80)},icon:"check_circle",color:this.getCompletionColor(r),description:"Quizzes fully completed"},{title:"Participation Rate",metric:{value:o,label:"Student Participation",unit:"%",trend:this.computeTrend(o,75)},icon:"groups",color:this.getParticipationColor(o),description:"Students taking quizzes"},{title:"Questions Bank",metric:{value:e.totals.questions,label:"Total Questions",unit:"questions"},icon:"quiz",color:"primary",description:"Questions in repository"},{title:"Classes",metric:{value:e.totals.classes,label:"Active Classes",unit:"classes"},icon:"class",color:"info",description:"Registered classes"}]}buildTeacherKpis(e,t){let r=this.countUniqueStudents(t),i=t.reduce((s,a)=>s+C(a),0),o=this.computeAverageScore(t),n=this.computeCompletionRate(t);return[{title:"My Courses",metric:{value:e.length,label:"Assigned Courses",unit:"courses"},icon:"menu_book",color:"primary",description:"Courses you teach"},{title:"My Students",metric:{value:r,label:"Total Students",unit:"students"},icon:"groups",color:"info",description:"Students in your courses"},{title:"Quizzes Created",metric:{value:t.length,label:"Total Quizzes",unit:"quizzes"},icon:"assignment",color:"success",description:"Assessments created"},{title:"Questions Created",metric:{value:i,label:"Total Questions",unit:"questions"},icon:"quiz",color:"primary",description:"In your quizzes"},{title:"Average Score",metric:{value:o,label:"Student Performance",unit:"%",trend:this.computeTrend(o,70)},icon:"trending_up",color:this.getScoreColor(o),description:"Your students average"},{title:"Completion Rate",metric:{value:n,label:"Quiz Completion",unit:"%",trend:this.computeTrend(n,80)},icon:"check_circle",color:this.getCompletionColor(n),description:"Quizzes fully completed"}]}computeScoreDistribution(e){let t=[];for(let s of e)if(s.studentQuizes)for(let a of s.studentQuizes)a.rawScore!==null&&a.rawScore!==void 0&&a.totalMarks&&t.push(a.rawScore/a.totalMarks*100);if(t.length===0)return this.getEmptyScoreDistribution();t.sort((s,a)=>s-a);let r=t.reduce((s,a)=>s+a,0)/t.length,i=t[Math.floor(t.length/2)],o=this.computeStdDev(t,r),n=[{range:"90-100",label:"excellent",count:0,percentage:0},{range:"80-89",label:"good",count:0,percentage:0},{range:"70-79",label:"average",count:0,percentage:0},{range:"60-69",label:"below",count:0,percentage:0},{range:"0-59",label:"failing",count:0,percentage:0}];for(let s of t)s>=90?n[0].count++:s>=80?n[1].count++:s>=70?n[2].count++:s>=60?n[3].count++:n[4].count++;for(let s of n)s.percentage=s.count/t.length*100;return{buckets:n,totalAssessed:t.length,averageScore:r,medianScore:i,standardDeviation:o,highestScore:t[t.length-1],lowestScore:t[0]}}buildScoreDistributionFromStats(e){let t=e.scores.averagePercent??0,r=e.scores.completedAttemptsWithScore;return r===0?this.getEmptyScoreDistribution():{buckets:this.estimateDistributionBuckets(t,r),totalAssessed:r,averageScore:t,medianScore:t,standardDeviation:15,highestScore:Math.min(100,t+30),lowestScore:Math.max(0,t-40)}}computePerformanceTrends(e,t="month"){let r=this.groupQuizzesByPeriod(e,t),i=Object.entries(r).map(([s,a])=>{let c=[],l=0,p=0;for(let u of a)if(u.studentQuizes){l+=u.studentQuizes.length;for(let d of u.studentQuizes)d.status==="SUBMITTED"&&p++,d.rawScore!==null&&d.rawScore!==void 0&&d.totalMarks&&c.push(d.rawScore/d.totalMarks*100)}return{period:s,averageScore:c.length>0?c.reduce((u,d)=>u+d,0)/c.length:0,participationRate:l,completionRate:l>0?p/l*100:0,studentCount:l}});i.sort((s,a)=>s.period.localeCompare(a.period));let o="stable",n=0;if(i.length>=2){let s=i[0].averageScore,a=i[i.length-1].averageScore;n=s>0?(a-s)/s*100:0,o=n>2?"up":n<-2?"down":"stable"}return{timeRange:t,dataPoints:i,overallTrend:o,percentageChange:n}}computeQuizAnalytics(e){let t={},r=0,i=0;for(let a of e){let c=a.type||"OTHER";if(t[c]||(t[c]={type:c,count:0,percentage:0,averageScore:0,completionRate:0}),t[c].count++,a.durationMinutes&&(r+=a.durationMinutes,i++),a.studentQuizes){let l=[],p=0;for(let u of a.studentQuizes)u.status==="SUBMITTED"&&p++,u.rawScore!==null&&u.rawScore!==void 0&&u.totalMarks&&l.push(u.rawScore/u.totalMarks*100);if(l.length>0){let u=l.reduce((d,A)=>d+A,0)/l.length;t[c].averageScore=(t[c].averageScore*(t[c].count-1)+u)/t[c].count}if(a.studentQuizes.length>0){let u=p/a.studentQuizes.length*100;t[c].completionRate=(t[c].completionRate*(t[c].count-1)+u)/t[c].count}}}for(let a of Object.values(t))a.percentage=a.count/e.length*100;let o=e.map(a=>{let c=this.computeQuizAverageScore(a),l=this.computeQuizCompletionRate(a);return{quizId:a.id,quizType:a.type,averageScore:c,completionRate:l,failureRate:100-c,attemptCount:a.studentQuizes?.length||0}}),n=[...o].filter(a=>a.attemptCount>0).sort((a,c)=>a.averageScore-c.averageScore).slice(0,5),s=[...o].filter(a=>a.attemptCount>0).sort((a,c)=>c.averageScore-a.averageScore).slice(0,5);return{totalQuizzes:e.length,activeQuizzes:e.length,completedQuizzes:e.filter(a=>a.studentQuizes?.some(c=>c.status==="SUBMITTED")).length,byType:Object.values(t),hardestQuizzes:n,easiestQuizzes:s,averageCompletionRate:this.computeCompletionRate(e),averageDuration:i>0?r/i:0}}buildParticipationAnalytics(e){let t=e.participation.invited+e.participation.inProgress+e.participation.completed+e.participation.missed,r=[{status:"Invited",count:e.participation.invited,percentage:0},{status:"In Progress",count:e.participation.inProgress,percentage:0},{status:"Completed",count:e.participation.completed,percentage:0},{status:"Missed",count:e.participation.missed,percentage:0}];for(let i of r)i.percentage=t>0?i.count/t*100:0;return{totalInvitations:t,totalParticipants:e.participation.inProgress+e.participation.completed,participationRate:t>0?(e.participation.inProgress+e.participation.completed)/t*100:0,completionRate:t>0?e.participation.completed/t*100:0,byStatus:r,averageTimeToStart:0,averageCompletionTime:0}}buildComparativeAnalysis(){return{bySpeciality:[],byLevel:[],byClass:[],byTeachingUnit:[],topPerformers:[],needsAttention:[]}}generateAlerts(e){let t=[],r=new Date().toISOString(),i=e.participation.invited+e.participation.inProgress+e.participation.completed+e.participation.missed,o=i>0?e.participation.completed/i*100:0;o<60&&t.push({id:"low-completion",severity:"warning",category:"participation",title:"Low Completion Rate",message:`Quiz completion rate is ${o.toFixed(1)}%. Consider reviewing quiz difficulty or providing more time.`,createdAt:r}),(e.scores.averagePercent??0)<60&&t.push({id:"low-score",severity:"warning",category:"performance",title:"Below Average Performance",message:`Average score is ${e.scores.averagePercent?.toFixed(1)}%. Students may need additional support.`,createdAt:r});let n=i>0?e.participation.missed/i*100:0;return n>20&&t.push({id:"high-missed",severity:"critical",category:"participation",title:"High Missed Quiz Rate",message:`${n.toFixed(1)}% of quiz invitations were missed. Consider sending reminders or adjusting schedules.`,createdAt:r}),t}generateRecommendations(e){let t=[];return e.totals.quizzes<e.totals.classes*2&&t.push({id:"more-quizzes",title:"Increase Assessment Frequency",description:"Consider creating more quizzes to improve continuous assessment and student engagement.",impact:"high",effort:"medium",category:"engagement",actionUrl:"/teacher/create-exam"}),e.totals.questions<100&&t.push({id:"grow-question-bank",title:"Expand Question Bank",description:"Build a larger question repository to enable more varied assessments and reduce question repetition.",impact:"medium",effort:"high",category:"content",actionUrl:"/teacher/question-bank"}),(e.totals.students>0?Math.min(100,(e.participation.completed+e.participation.inProgress)/e.totals.students*100):0)<70&&t.push({id:"improve-participation",title:"Boost Student Participation",description:"Participation rate is below 70%. Consider using reminder notifications and making quizzes more accessible.",impact:"high",effort:"low",category:"engagement"}),t}generateTeacherAlerts(e){let t=[],r=new Date().toISOString();for(let i of e){if(!i.studentQuizes||i.studentQuizes.length===0)continue;let n=i.studentQuizes.filter(s=>s.status==="SUBMITTED").length/i.studentQuizes.length*100;n<50&&i.studentQuizes.length>=5&&t.push({id:`low-completion-${i.id}`,severity:"warning",category:"participation",title:"Low Quiz Completion",message:`Only ${n.toFixed(0)}% of students completed quiz "${i.type}".`,entityType:"quiz",entityId:i.id,createdAt:r})}return e.length===0&&t.push({id:"no-quizzes",severity:"info",category:"engagement",title:"No Quizzes Created",message:"You haven't created any quizzes yet. Start assessing your students!",actionUrl:"/teacher/create-exam",actionLabel:"Create Quiz",createdAt:r}),t}buildDeanDashboard(e,t,r){return{generatedAt:new Date().toISOString(),timeRange:r?.timeRange||"all",kpis:this.buildDeanKpis(e),studentDemographics:this.buildStudentDemographics(e),teacherDemographics:this.buildTeacherDemographics(e),academicPerformance:this.buildScoreDistributionFromStats(e),performanceTrends:this.getEmptyPerformanceTrends(),quizAnalytics:this.buildQuizAnalyticsFromStats(e),participation:this.buildParticipationAnalytics(e),comparativeAnalysis:this.buildComparativeAnalysis(),alerts:this.generateAlerts(e),recommendations:this.generateRecommendations(e)}}buildTeacherDashboard(e,t,r){return{generatedAt:new Date().toISOString(),teacherId:"",timeRange:r?.timeRange||"all",kpis:this.buildTeacherKpis(e,t),coursePerformance:this.buildCoursePerformance(e,t),studentPerformance:this.buildStudentPerformance(t),scoreDistribution:this.computeScoreDistribution(t),performanceTrends:this.computePerformanceTrends(t,r?.timeRange||"month"),quizAnalytics:this.computeQuizAnalytics(t),questionDifficulty:this.computeQuestionDifficulty(t),alerts:this.generateTeacherAlerts(t),recommendations:[]}}buildStudentDemographics(e){return{totalStudents:e.totals.students,activeStudents:e.totals.students,inactiveStudents:0,bySpeciality:[],byLevel:[],byClass:[],newEnrollmentsThisMonth:0}}buildTeacherDemographics(e){return{totalTeachers:e.totals.teachers,bySpeciality:[],teachersWithCourses:e.totals.teachers,teachersWithoutCourses:0,averageCoursesPerTeacher:0}}buildQuizAnalyticsFromStats(e){return{totalQuizzes:e.totals.quizzes,activeQuizzes:e.totals.quizzes,completedQuizzes:0,byType:[],hardestQuizzes:[],easiestQuizzes:[],averageCompletionRate:0,averageDuration:0}}buildCoursePerformance(e,t){return e.map(r=>{let i=t.filter(o=>o.courseQuizes?.some(n=>n.course?.id===r.id));return{id:r.id,name:r.teachingUnit?.name||"Unknown Course",studentCount:0,quizCount:i.length,averageScore:this.computeAverageScore(i),completionRate:this.computeCompletionRate(i),participationRate:0,trend:"stable"}})}buildStudentPerformance(e){let t=new Map;for(let i of e)if(i.studentQuizes)for(let o of i.studentQuizes){if(!o.student||o.rawScore===null||o.rawScore===void 0||!o.totalMarks)continue;let n=o.student.id,s=o.student.user?.name||o.student.matricule||"Unknown",a=o.rawScore/o.totalMarks*100;t.has(n)||t.set(n,{name:s,scores:[]}),t.get(n).scores.push(a)}let r=Array.from(t.entries()).map(([i,o])=>({studentId:i,name:o.name,averageScore:o.scores.reduce((n,s)=>n+s,0)/o.scores.length}));return r.sort((i,o)=>o.averageScore-i.averageScore),{topPerformers:r.slice(0,10),needsHelp:r.filter(i=>i.averageScore<60).slice(0,10)}}computeQuestionDifficulty(e){return[]}computeAverageScore(e){let t=0,r=0;for(let i of e)if(i.studentQuizes)for(let o of i.studentQuizes)o.rawScore!==null&&o.rawScore!==void 0&&o.totalMarks&&(t+=o.rawScore/o.totalMarks*100,r++);return r>0?t/r:0}computeCompletionRate(e){let t=0,r=0;for(let i of e)i.studentQuizes&&(t+=i.studentQuizes.length,r+=i.studentQuizes.filter(o=>o.status==="SUBMITTED").length);return t>0?r/t*100:0}countUniqueStudents(e){let t=new Set;for(let r of e)if(r.studentQuizes)for(let i of r.studentQuizes)i.student?.id&&t.add(i.student.id);return t.size}computeQuizAverageScore(e){if(!e.studentQuizes)return 0;let t=0,r=0;for(let i of e.studentQuizes)i.rawScore!==null&&i.rawScore!==void 0&&i.totalMarks&&(t+=i.rawScore/i.totalMarks*100,r++);return r>0?t/r:0}computeQuizCompletionRate(e){return!e.studentQuizes||e.studentQuizes.length===0?0:e.studentQuizes.filter(r=>r.status==="SUBMITTED").length/e.studentQuizes.length*100}computeTrend(e,t){let r=e-t;return r>5?"up":r<-5?"down":"stable"}getScoreColor(e){return e>=80?"success":e>=60?"warning":"danger"}getCompletionColor(e){return e>=80?"success":e>=60?"warning":"danger"}getParticipationColor(e){return e>=75?"success":e>=50?"warning":"danger"}computeStdDev(e,t){let i=e.map(o=>Math.pow(o-t,2)).reduce((o,n)=>o+n,0)/e.length;return Math.sqrt(i)}estimateDistributionBuckets(e,t){let i=[{range:"90-100",label:"excellent",count:0,percentage:0},{range:"80-89",label:"good",count:0,percentage:0},{range:"70-79",label:"average",count:0,percentage:0},{range:"60-69",label:"below",count:0,percentage:0},{range:"0-59",label:"failing",count:0,percentage:0}],o=[95,84.5,74.5,64.5,30];for(let n=0;n<i.length;n++){let s=(o[n]-e)/15,a=this.normalCDF(s),c=n===i.length-1?0:this.normalCDF((o[n+1]-e)/15);i[n].percentage=Math.max(0,(a-c)*100),i[n].count=Math.round(t*i[n].percentage/100)}return i}normalCDF(e){let t=.254829592,r=-.284496736,i=1.421413741,o=-1.453152027,n=1.061405429,s=.3275911,a=e<0?-1:1;e=Math.abs(e)/Math.sqrt(2);let c=1/(1+s*e),l=1-((((n*c+o)*c+i)*c+r)*c+t)*c*Math.exp(-e*e);return .5*(1+a*l)}groupQuizzesByPeriod(e,t){let r={};for(let i of e){if(!i.date)continue;let o=new Date(i.date),n;switch(t){case"week":n=`Week ${this.getWeekNumber(o)}`;break;case"month":n=o.toLocaleDateString("en-US",{month:"short",year:"numeric"});break;case"semester":n=`${o.getMonth()<6?"S1":"S2"} ${o.getFullYear()}`;break;case"year":default:n=o.getFullYear().toString()}r[n]||(r[n]=[]),r[n].push(i)}return r}getWeekNumber(e){let t=new Date(e.getFullYear(),0,1),r=(e.getTime()-t.getTime())/864e5;return Math.ceil((r+t.getDay()+1)/7)}getEmptyDeanDashboard(){return{generatedAt:new Date().toISOString(),timeRange:"all",kpis:[],studentDemographics:{totalStudents:0,activeStudents:0,inactiveStudents:0,bySpeciality:[],byLevel:[],byClass:[],newEnrollmentsThisMonth:0},teacherDemographics:{totalTeachers:0,bySpeciality:[],teachersWithCourses:0,teachersWithoutCourses:0,averageCoursesPerTeacher:0},academicPerformance:this.getEmptyScoreDistribution(),performanceTrends:this.getEmptyPerformanceTrends(),quizAnalytics:{totalQuizzes:0,activeQuizzes:0,completedQuizzes:0,byType:[],hardestQuizzes:[],easiestQuizzes:[],averageCompletionRate:0,averageDuration:0},participation:{totalInvitations:0,totalParticipants:0,participationRate:0,completionRate:0,byStatus:[],averageTimeToStart:0,averageCompletionTime:0},comparativeAnalysis:{bySpeciality:[],byLevel:[],byClass:[],byTeachingUnit:[],topPerformers:[],needsAttention:[]},alerts:[],recommendations:[]}}getEmptyTeacherDashboard(){return{generatedAt:new Date().toISOString(),teacherId:"",timeRange:"all",kpis:[],coursePerformance:[],studentPerformance:{topPerformers:[],needsHelp:[]},scoreDistribution:this.getEmptyScoreDistribution(),performanceTrends:this.getEmptyPerformanceTrends(),quizAnalytics:{totalQuizzes:0,activeQuizzes:0,completedQuizzes:0,byType:[],hardestQuizzes:[],easiestQuizzes:[],averageCompletionRate:0,averageDuration:0},questionDifficulty:[],alerts:[],recommendations:[]}}getEmptyScoreDistribution(){return{buckets:[{range:"90-100",label:"excellent",count:0,percentage:0},{range:"80-89",label:"good",count:0,percentage:0},{range:"70-79",label:"average",count:0,percentage:0},{range:"60-69",label:"below",count:0,percentage:0},{range:"0-59",label:"failing",count:0,percentage:0}],totalAssessed:0,averageScore:0,medianScore:0,standardDeviation:0,highestScore:0,lowestScore:0}}getEmptyPerformanceTrends(){return{timeRange:"month",dataPoints:[],overallTrend:"stable",percentageChange:0}}static \u0275fac=function(t){return new(t||g)};static \u0275prov=v({token:g,factory:g.\u0275fac,providedIn:"root"})};export{T as a};
