<div class="sentiment-analysis">
  <div class="page-header">
    <div class="header-content">
      <h1><mat-icon>psychology</mat-icon> {{ pageTitle() }}</h1>
      <p>{{ pageSubtitle() }}</p>
    </div>
  </div>

  <ui-alert *ngIf="errorMessage()" color="danger" class="error-alert">
    <mat-icon>error_outline</mat-icon>
    {{ errorMessage() }}
  </ui-alert>

  <div *ngIf="isLoadingQuizzes(); else loaded">
    <div class="loading-state">
      <ui-spinner size="lg"></ui-spinner>
      <p>Loading quizzes...</p>
    </div>
  </div>

  <ng-template #loaded>
    <div class="selection-grid">
      <ui-card class="selection-card">
        <div class="selection-header">
          <h2>Select a Quiz to Analyze</h2>
          <p>Choose a completed quiz with an open-ended question</p>
        </div>

        <div *ngIf="quizOptions().length === 0" class="empty-state">
          <mat-icon>quiz</mat-icon>
          <h3>No quizzes available</h3>
          <p>There are no quizzes with open-ended questions available for analysis.</p>
        </div>

        <div *ngIf="quizOptions().length > 0" class="quiz-selector">
          <ui-select
            label="Quiz"
            placeholder="Select a quiz..."
            [options]="quizSelectOptions()"
            [ngModel]="selectedQuizId()"
            (ngModelChange)="onQuizSelected($event)"
            [searchable]="true"
          ></ui-select>

          <div *ngIf="selectedQuiz() as quiz" class="quiz-details">
            <div class="detail-row"><span class="label">Question:</span><span class="value">{{ quiz.openEndedQuestion?.question }}</span></div>
            <div class="detail-row"><span class="label">Course:</span><span class="value">{{ quiz.courseName }}</span></div>
            <div class="detail-row"><span class="label">Type:</span><span class="value">{{ quiz.type }}</span></div>
            <div class="detail-row"><span class="label">Date:</span><span class="value">{{ quiz.date }}</span></div>
            <div class="detail-row"><span class="label">Students:</span><span class="value">{{ quiz.submittedCount }} / {{ quiz.studentCount }} submitted</span></div>
            <div class="detail-row progress-row">
              <span class="label">Submissions:</span>
              <span class="value">
                <div class="progress-track"><div class="progress-fill" [style.width]="(quiz.studentCount ? (quiz.submittedCount / quiz.studentCount * 100) : 0) + '%'"></div></div>
              </span>
            </div>
            <div class="detail-row">
              <span class="label">Status:</span>
              <ui-badge *ngIf="quiz.isFinished" color="success">Completed</ui-badge>
              <ui-badge *ngIf="!quiz.isFinished" color="warning">In Progress</ui-badge>
            </div>

            <div *ngIf="isLoadingExisting()" class="existing-loading"><ui-spinner size="sm"></ui-spinner><span>Checking for existing analyses...</span></div>

            <div *ngIf="hasExistingAnalysis()" class="existing-analyses">
              <h4><mat-icon>history</mat-icon> Previous Analyses</h4>
              <div class="analyses-list">
                <button *ngFor="let analysis of existingAnalyses()" class="analysis-item" [class.active]="analysisResult()?.id === analysis.id" (click)="viewExistingAnalysis(analysis)">
                  <div class="analysis-item-info">
                    <ui-badge [color]="analysis.status === 'COMPLETED' ? 'success' : 'danger'" size="sm">{{ analysis.status }}</ui-badge>
                    <span class="analysis-date">{{ formatDateTime(analysis.analyzedAt) }}</span>
                  </div>
                  <span class="analysis-model">{{ analysis.model }}</span>
                </button>
              </div>
            </div>

            <div class="analyze-actions">
              <ui-button [disabled]="!canAnalyze()" (click)="runAnalysis()">
                <ng-container *ngIf="isAnalyzing(); else readyBtn">
                  <ui-spinner size="sm"></ui-spinner>
                  <span>Analyzing...</span>
                </ng-container>
                <ng-template #readyBtn>
                  <mat-icon>auto_awesome</mat-icon>
                  <span>{{ hasExistingAnalysis() ? 'Run New Analysis' : 'Run AI Analysis' }}</span>
                </ng-template>
              </ui-button>
              <p *ngIf="!quiz.isFinished" class="hint">Quiz must be completed before analysis</p>
            </div>
          </div>
        </div>
      </ui-card>

      <ui-card class="all-analyses">
        <div class="selection-header"><h2>All Past Analyses</h2><p>Browse previous sentiment analyses across quizzes</p></div>

        <div *ngIf="isLoadingAllAnalyses()" class="existing-loading"><ui-spinner size="sm"></ui-spinner><span>Loading analyses...</span></div>
        <div *ngIf="!isLoadingAllAnalyses() && allAnalyses().length === 0" class="empty-state">
          <mat-icon>history</mat-icon><h3>No analyses yet</h3><p>No past sentiment analyses have been run.</p>
        </div>

        <div class="analyses-list" *ngIf="allAnalyses().length > 0">
          <button *ngFor="let analysis of allAnalyses()" class="analysis-item" [class.active]="analysisResult()?.id === analysis.id" (click)="viewExistingAnalysis(analysis)">
            <div class="analysis-item-main">
              <div class="analysis-title">{{ analysis.resultJson?.summary ?? (analysis.questionText ?? ('Analysis for quiz ' + (analysis.quizId || ''))) }}</div>
              <div class="analysis-subinfo">
                <span class="analysis-course">{{ analysis.quiz?.courseName ?? analysis.courseName ?? ('Quiz: ' + (analysis.quizId || '')) }}</span>
                <span class="sep">•</span>
                <span class="analysis-type">{{ analysis.quiz?.type ?? analysis.type ?? '—' }}</span>
                <span class="sep">•</span>
                <span class="analysis-date">{{ formatDateTime(analysis.analyzedAt) }}</span>
              </div>
            </div>
            <div class="analysis-meta-brief">
              <div class="analysis-model">Model: {{ analysis.model }}</div>
              <div class="analysis-ref">Q: {{ analysis.questionId }} • {{ analysis.resultJson?.counts?.answersProvided ?? 0 }} responses</div>
            </div>
          </button>
        </div>
      </ui-card>
    </div>

    <div *ngIf="result() as res" class="results-section">
      <ui-card class="sentiment-overview" [ngClass]="sentimentColor()">
        <div class="overview-header">
          <div class="sentiment-icon-wrapper" [ngClass]="sentimentColor()"><mat-icon>{{ sentimentIcon() }}</mat-icon></div>
          <div class="overview-content"><h2>{{ res.overallSentiment }} Sentiment</h2><p class="summary">{{ res.summary }}</p></div>
        </div>
        <div class="metrics-grid">
          <div class="metric"><span class="metric-value">{{ confidencePercent() }}%</span><span class="metric-label">Confidence</span></div>
          <div class="metric"><span class="metric-value">{{ answersAnalyzed().provided }}</span><span class="metric-label">Responses Analyzed</span></div>
          <div class="metric"><span class="metric-value">{{ answersAnalyzed().empty }}</span><span class="metric-label">Empty Responses</span></div>
          <div class="metric" *ngIf="res.sentimentScore !== undefined"><span class="metric-value">{{ res.sentimentScore | number:'1.2-2' }}</span><span class="metric-label">Score (-1 to 1)</span></div>
        </div>
      </ui-card>

      <div class="analysis-grid">
        <ui-card *ngIf="topEmotions().length > 0" class="emotions-card">
          <h3><mat-icon>mood</mat-icon> Detected Emotions</h3>
          <div class="emotions-list">
            <div *ngFor="let emotion of topEmotions(); let i = index" class="emotion-item">
              <div class="emotion-header"><span class="emotion-label">{{ emotion.label }}</span><span class="emotion-score">{{ emotion.score * 100 | number:'1.0-0' }}%</span></div>
              <div class="emotion-bar-track"><div class="emotion-bar-fill" [style.width]="getEmotionBarWidth(emotion.score)" [style.backgroundColor]="getEmotionColor(i)"></div></div>
            </div>
          </div>
        </ui-card>

        <ui-card *ngIf="themes().length > 0" class="themes-card">
          <h3><mat-icon>tag</mat-icon> Key Themes</h3>
          <div class="themes-list">
            <div *ngFor="let theme of themes()" class="theme-item">
              <div class="theme-header"><span class="theme-name">{{ theme.theme }}</span><ui-badge color="neutral">{{ theme.frequency }} mentions</ui-badge></div>
              <ul *ngIf="theme.examples && theme.examples.length > 0" class="theme-examples"><li *ngFor="let example of theme.examples">"{{ example }}"</li></ul>
            </div>
          </div>
        </ui-card>
      </div>

      <div class="insights-grid">
        <ui-card *ngIf="insights().length > 0" class="insights-card"><h3><mat-icon>lightbulb</mat-icon> Actionable Insights</h3><ul class="insights-list"><li *ngFor="let insight of insights()"><mat-icon>arrow_right</mat-icon>{{ insight }}</li></ul></ui-card>
        <ui-card *ngIf="concerns().length > 0" class="concerns-card"><h3><mat-icon>warning_amber</mat-icon> Student Concerns</h3><ul class="concerns-list"><li *ngFor="let concern of concerns()"><mat-icon>report_problem</mat-icon>{{ concern }}</li></ul></ui-card>
      </div>

      <div class="analysis-meta"><span><mat-icon>smart_toy</mat-icon> Analyzed by: {{ analysisResult()?.model }}</span><span><mat-icon>schedule</mat-icon> {{ analysisResult()?.analyzedAt | date:'medium' }}</span></div>
    </div>

    <ui-card *ngIf="analysisResult()?.status === 'FAILED'" class="failed-card">
      <div class="failed-content"><mat-icon>error_outline</mat-icon><h3>Analysis Failed</h3><p>{{ analysisResult()?.error ?? 'An unknown error occurred during analysis.' }}</p><ui-button variant="outline" (click)="runAnalysis()"><mat-icon>refresh</mat-icon>Retry Analysis</ui-button></div>
    </ui-card>
  </ng-template>
</div>
