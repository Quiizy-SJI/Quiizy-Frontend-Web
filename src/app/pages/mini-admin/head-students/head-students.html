<div class="students">
  <header class="students__header">
    <div class="students__title-section">
      <h1 class="students__title">Student Management</h1>
      <p class="students__subtitle">Create, import students and details</p>
    </div>

    <div class="students__header-actions">
      <ui-button color="primary" variant="solid" size="sm" (clicked)="openCreate()">
        + Add student
      </ui-button>

      <ui-select
        label="Select academic year"
        [options]="academicYearOptions()"
        [(ngModel)]="selectedAcademicYearId"
        (ngModelChange)="onAcademicYearChanged()"
        [searchable]="true"
      ></ui-select>

      <ui-select
        label="Select level"
        [options]="levelOptions()"
        [(ngModel)]="selectedLevel"
        (ngModelChange)="applyFilters()"
        [searchable]="true"
      ></ui-select>
    </div>
  </header>

  @if (errorMessage) {
    <ui-alert type="danger" variant="outlined">
      {{ errorMessage }}
    </ui-alert>
  }

  @if (infoMessage) {
    <ui-alert type="info" variant="outlined">
      {{ infoMessage }}
    </ui-alert>
  }

  <div class="students__toolbar">
    

    <ui-button color="warning" variant="soft" size="sm" (clicked)="importExcel()">
      Import Excel
    </ui-button>

    <ui-button color="secondary" variant="soft" size="sm" (clicked)="exportExcel()">
      Export Excel
    </ui-button>
  </div>

  <section class="students__grid">
    <ui-card variant="outlined" class="panel">
      <div class="panel__header">
        <div class="panel__title">Students Directory</div>
        <div class="panel__subtitle">View student matricule, name, class and other info.</div>
      </div>

      <ui-table
        [columns]="columns"
        [data]="pagedRows"
        [loading]="loading"
        [searchable]="true"
        [selectable]="true"
        [rowClickable]="true"
        [showPagination]="true"
        [pagination]="pagination"
        trackByKey="id"
        (rowClick)="onRowClick($event.row)"
        (selectionChange)="onSelectionChange($event)"
        (pageChange)="onPageChange($event)"
        (pageSizeChange)="onPageSizeChange($event)"
      >
        <ng-template #cell let-row let-column="column">
          @switch (column.key) {
            @case ('actions') {
              <div class="table-actions">
                <ui-button size="sm" variant="soft" color="primary" (clicked)="selectRow(row)">View</ui-button>
                <ui-button size="sm" variant="soft" color="secondary" (clicked)="openEdit(row)">Edit</ui-button>
                <ui-button size="sm" variant="soft" color="danger" (clicked)="openDelete(row)">Delete</ui-button>
              </div>
            }
            @default {
              {{ row[column.key] }}
            }
          }
        </ng-template>

        <ng-template #empty>
          <div class="table-empty">No students found for this scope.</div>
        </ng-template>
      </ui-table>
    </ui-card>

    <ui-card variant="outlined" class="panel">
      <div class="panel__header">
        <div class="panel__title">Student Details</div>
      </div>

      @if (!selectedRow) {
        <div class="detail-empty">
          Select a student to view details.
        </div>
      } @else {
        <div class="detail">
          <div class="detail__top">
            <div class="detail__name">{{ selectedRow.name }} {{ selectedRow.surname }}</div>
            <div class="detail__meta">
              <ui-badge color="primary" variant="subtle">{{ selectedRow.className }}</ui-badge>
              @if (selectedRow.academicYearLabel) {
                <ui-badge color="neutral" variant="subtle">{{ selectedRow.academicYearLabel }}</ui-badge>
              }
            </div>
          </div>

          <div class="detail__fields">
            <div class="detail-field">
              <div class="detail-field__label">Matricule</div>
              <div class="detail-field__value">{{ selectedRow.matricule }}</div>
            </div>
            <div class="detail-field">
              <div class="detail-field__label">Class</div>
              <div class="detail-field__value">{{ selectedRow.className }}</div>
            </div>
            <div class="detail-field">
              <div class="detail-field__label">Email</div>
              <div class="detail-field__value">{{ selectedRow.email }}</div>
            </div>
          </div>

          <div class="detail__actions">
            <ui-button color="secondary" variant="soft" size="sm" (clicked)="openEdit()">
              Edit Student
            </ui-button>
            <ui-button color="danger" variant="soft" size="sm" (clicked)="openDelete()">
              Delete Student
            </ui-button>
          </div>
        </div>
      }
    </ui-card>
  </section>


  <!-- Create modal -->
  <ui-modal
    [isOpen]="createOpen"
    title="Add Student"
    [showFooter]="true"
    (closed)="createOpen = false"
  >
    <div class="modal-form">
      <ui-input label="Matricule" [(ngModel)]="draftMatricule" placeholder="e.g., 23251768"></ui-input>
      <ui-input label="Name" [(ngModel)]="draftName" placeholder="e.g., Jerry"></ui-input>
      <ui-input label="Surname" [(ngModel)]="draftSurname" placeholder="e.g., George"></ui-input>
      <ui-input label="Email" [(ngModel)]="draftEmail" placeholder="e.g., jerry.george@example.com"></ui-input>
      <ui-input label="Login" [(ngModel)]="draftLogin" placeholder="e.g., jerry.george"></ui-input>
      <ui-input label="Password" type="password" [(ngModel)]="draftPassword" placeholder="Min 6 characters"></ui-input>
      <ui-select
        label="Class"
        [options]="classOptions()"
        [(ngModel)]="draftClassAcademicYearId"
        [searchable]="true"
      ></ui-select>
    </div>

    <div slot="footer" class="modal-actions">
      <ui-button variant="soft" color="neutral" (clicked)="createOpen = false">Cancel</ui-button>
      <ui-button color="primary" (clicked)="confirmCreate()">Create</ui-button>
    </div>
  </ui-modal>

  <!-- Edit modal -->
  <ui-modal
    [isOpen]="editOpen"
    title="Edit Student"
    [showFooter]="true"
    (closed)="editOpen = false"
  >
    <div class="modal-form">
      <ui-input label="Matricule" [(ngModel)]="draftMatricule"></ui-input>
      <ui-input label="Name" [(ngModel)]="draftName"></ui-input>
      <ui-input label="Surname" [(ngModel)]="draftSurname"></ui-input>
      <ui-input label="Email" [(ngModel)]="draftEmail"></ui-input>
      <ui-input label="Login" [(ngModel)]="draftLogin"></ui-input>
      <ui-input label="Password (leave blank to keep)" type="password" [(ngModel)]="draftPassword"></ui-input>
      <ui-select
        label="Class"
        [options]="classOptions()"
        [(ngModel)]="draftClassAcademicYearId"
        [searchable]="true"
      ></ui-select>
    </div>

    <div slot="footer" class="modal-actions">
      <ui-button variant="soft" color="neutral" (clicked)="editOpen = false">Cancel</ui-button>
      <ui-button color="primary" (clicked)="confirmEdit()">Save</ui-button>
    </div>
  </ui-modal>

  <!-- Delete modal -->
  <ui-modal
    [isOpen]="deleteOpen"
    title="Delete Student"
    description="This will delete the student."
    [showFooter]="true"
    (closed)="deleteOpen = false"
  >
    <div class="delete-confirm">
      @if (selectedRow) {
        Are you sure you want to delete <strong>{{ selectedRow.name }} {{ selectedRow.surname }}</strong>?
      }
    </div>

    <div slot="footer" class="modal-actions">
      <ui-button variant="soft" color="neutral" (clicked)="deleteOpen = false">Cancel</ui-button>
      <ui-button color="danger" (clicked)="confirmDelete()">Delete</ui-button>
    </div>
  </ui-modal>
</div>
