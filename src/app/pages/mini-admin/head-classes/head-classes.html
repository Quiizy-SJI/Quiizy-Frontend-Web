<div class="classes">
  <header class="classes__header">
    <div class="classes__title-section">
      <h1 class="classes__title">Class Management</h1>
      <p class="classes__subtitle">Create, import classes</p>
    </div>

    <div class="classes__header-actions">
      <ui-button color="primary" variant="solid" size="sm" (clicked)="openCreate()">
        + Create Class
      </ui-button>

      <ui-select
        label="Select academic year"
        [options]="academicYearOptions()"
        [(ngModel)]="selectedAcademicYearId"
        [searchable]="true"
        (valueChange)="onAcademicYearChanged()"
      ></ui-select>
    </div>
  </header>

  @if (errorMessage) {
    <ui-alert type="danger" variant="outlined">
      {{ errorMessage }}
    </ui-alert>
  }

  @if (infoMessage) {
    <ui-alert type="info" variant="outlined">
      {{ infoMessage }}
    </ui-alert>
  }

  <div class="classes__toolbar">

    <ui-button color="warning" variant="soft" size="sm" (clicked)="importExcel()">
      Import Excel
    </ui-button>

    <ui-button color="secondary" variant="soft" size="sm" (clicked)="exportExcel()">
      Export Excel
    </ui-button>
  </div>

  <section class="classes__grid">
    <ui-card variant="outlined" class="panel">
      <div class="panel__header">
        <div class="panel__title">Classes Overview</div>
        <div class="panel__subtitle">Teacher/class assignments are completed by specialty heads.</div>
      </div>

      <ui-table
        [columns]="columns"
        [data]="pagedRows"
        [loading]="loading"
        [searchable]="true"
        [selectable]="true"
        [rowClickable]="true"
        [showPagination]="true"
        [pagination]="pagination"
        trackByKey="id"
        (rowClick)="onRowClick($event.row)"
        (selectionChange)="onSelectionChange($event)"
        (pageChange)="onPageChange($event)"
        (pageSizeChange)="onPageSizeChange($event)"
      >
        <ng-template #cell let-row let-column="column">
          @switch (column.key) {
            @case ('actions') {
              <div class="table-actions">
                <ui-button size="sm" variant="soft" color="primary" (clicked)="selectRow(row)">View</ui-button>
                <ui-button size="sm" variant="soft" color="secondary" (clicked)="openEdit(row)">Edit</ui-button>
                <ui-button size="sm" variant="soft" color="danger" (clicked)="openDelete(row)">Delete</ui-button>
              </div>
            }
            @default {
              {{ row[column.key] }}
            }
          }
        </ng-template>

        <ng-template #empty>
          <div class="table-empty">No classes found for this scope.</div>
        </ng-template>
      </ui-table>
    </ui-card>

    <ui-card variant="outlined" class="panel">
      <div class="panel__header">
        <div class="panel__title">Class Detail</div>
      </div>

      @if (!selectedRow) {
        <div class="detail-empty">
          Select a class to view details.
        </div>
      } @else {
        <div class="detail">
          <div class="detail__top">
            <div class="detail__name">{{ selectedRow.className }}</div>
            <div class="detail__meta">
              <ui-badge color="primary" variant="subtle">Level {{ selectedRow.level || 'â€”' }}</ui-badge>
              <ui-badge color="neutral" variant="subtle">{{ selectedRow.academicYearLabel }}</ui-badge>
            </div>
          </div>

          <div class="detail__stats">
            <div class="detail-stat">
              <div class="detail-stat__label">Students</div>
              <div class="detail-stat__value">{{ selectedRow.students }}</div>
            </div>
            <div class="detail-stat">
              <div class="detail-stat__label">Teachers</div>
              <div class="detail-stat__value">{{ selectedRow.teachers }}</div>
            </div>
            <div class="detail-stat">
              <div class="detail-stat__label">Subjects</div>
              <div class="detail-stat__value">{{ selectedRow.subjects }}</div>
            </div>
          </div>

          <div class="detail__actions">
            <ui-button color="secondary" variant="soft" size="sm" (clicked)="openEdit()">
              Edit Class
            </ui-button>
            <ui-button color="danger" variant="soft" size="sm" (clicked)="openDelete()">
              Delete Class
            </ui-button>
          </div>
        </div>
      }
    </ui-card>
  </section>

  <!-- Create modal -->
  <ui-modal
    [isOpen]="createOpen"
    title="Create Class"
    [showFooter]="true"
    (closed)="createOpen = false"
  >
    <div class="modal-form">
      <ui-input label="Class name" [(ngModel)]="draftName" placeholder="e.g., ING 4 ISI EN"></ui-input>
      <ui-input label="Level" [(ngModel)]="draftLevel" placeholder="e.g., 4"></ui-input>
      <ui-select
        label="Academic year"
        [options]="academicYearOptions()"
        [(ngModel)]="draftAcademicYearId"
        [searchable]="true"
      ></ui-select>
    </div>

    <div slot="footer" class="modal-actions">
      <ui-button variant="soft" color="neutral" (clicked)="createOpen = false">Cancel</ui-button>
      <ui-button color="primary" (clicked)="confirmCreate()">Create</ui-button>
    </div>
  </ui-modal>

  <!-- Edit modal -->
  <ui-modal
    [isOpen]="editOpen"
    title="Edit Class"
    [showFooter]="true"
    (closed)="editOpen = false"
  >
    <div class="modal-form">
      <ui-input label="Class name" [(ngModel)]="draftName"></ui-input>
      <ui-input label="Level" [(ngModel)]="draftLevel"></ui-input>
      <ui-select
        label="Academic year"
        [options]="academicYearOptions()"
        [(ngModel)]="draftAcademicYearId"
        [searchable]="true"
      ></ui-select>
    </div>

    <div slot="footer" class="modal-actions">
      <ui-button variant="soft" color="neutral" (clicked)="editOpen = false">Cancel</ui-button>
      <ui-button color="primary" (clicked)="confirmEdit()">Save</ui-button>
    </div>
  </ui-modal>

  <!-- Delete modal -->
  <ui-modal
    [isOpen]="deleteOpen"
    title="Delete Class"
    description="This will remove the class from the list (UI only)."
    [showFooter]="true"
    (closed)="deleteOpen = false"
  >
    <div class="delete-confirm">
      @if (selectedRow) {
        Are you sure you want to delete <strong>{{ selectedRow.className }}</strong>?
      }
    </div>

    <div slot="footer" class="modal-actions">
      <ui-button variant="soft" color="neutral" (clicked)="deleteOpen = false">Cancel</ui-button>
      <ui-button color="danger" (clicked)="confirmDelete()">Delete</ui-button>
    </div>
  </ui-modal>
</div>