import{a as Q,b as Z}from"./chunk-BT74ICIE.js";import{a as K}from"./chunk-ORD7MMJC.js";import{a as C}from"./chunk-O6YQIL4L.js";import{c as q,f as j,j as G,n as X}from"./chunk-AO6LNOWB.js";import{a as W}from"./chunk-SJBCNNOS.js";import{a as $,b as B}from"./chunk-2WUHN5CQ.js";import"./chunk-MAWX5T35.js";import{c as F,f as V,n as U,u as J}from"./chunk-XGVRFAFZ.js";import"./chunk-4BWE2P25.js";import"./chunk-LUIYB3PI.js";import"./chunk-LM6INHLT.js";import{$a as p,Ab as A,Db as N,Eb as H,Fb as R,Ka as T,Oa as I,Pb as D,Va as y,Wa as v,Ya as z,Z as E,Za as S,_a as w,ab as o,ba as h,bb as l,ca as _,cb as P,jb as Y,lb as M,nb as f,p as b,rc as L,xb as k,yb as c,za as d,zb as u}from"./chunk-3XB4H34J.js";var te=(i,e)=>e.name,ae=(i,e)=>e.message;function ne(i,e){i&1&&(o(0,"div",8),P(1,"ui-spinner",30),l()),i&2&&(d(),p("showLabel",!0))}function ie(i,e){if(i&1&&(o(0,"ui-alert",9),c(1),l()),i&2){let t=f();d(),A(" ",t.errorMessage," ")}}function se(i,e){i&1&&(o(0,"div",31)(1,"ui-button",32),c(2,"View"),l()())}function re(i,e){if(i&1&&c(0),i&2){let t=f(),n=t.$implicit,s=t.column;A(" ",n[s.key]," ")}}function oe(i,e){if(i&1&&y(0,se,3,0,"div",31)(1,re,1,1),i&2){let t,n=e.column;v((t=n.key)==="actions"?0:1)}}function le(i,e){if(i&1&&(o(0,"div",23),c(1),l()),i&2){let t=e.$implicit;d(),u(t)}}function de(i,e){if(i&1&&(o(0,"div",33)(1,"div",34),c(2),l(),o(3,"div",35),c(4),l()()),i&2){let t=e.$implicit;k("exam-item exam-item--"+t.tone),d(2),u(t.name),d(2),u(t.time)}}function ce(i,e){if(i&1&&(o(0,"div",28),P(1,"span"),o(2,"div",36)(3,"div",37),c(4),l(),o(5,"div",38),c(6),l()()()),i&2){let t=e.$implicit,n=f();d(),k(n.activityDotClass(t.tone)),d(3),u(t.message),d(2),u(t.timeAgo)}}function me(i,e){i&1&&(o(0,"div",39),c(1,"No critical alerts right now."),l())}function ge(i,e){if(i&1&&(o(0,"ui-badge",40),c(1),l()),i&2){let t=f().$implicit,n=f();p("color",n.moodColor(t.mood)),d(),u(t.mood)}}function pe(i,e){i&1&&(o(0,"div",31)(1,"ui-button",32),c(2,"Review"),l()())}function ue(i,e){if(i&1&&c(0),i&2){let t=f(),n=t.$implicit,s=t.column;A(" ",n[s.key]," ")}}function he(i,e){if(i&1&&y(0,ge,2,2,"ui-badge",40)(1,pe,3,0,"div",31)(2,ue,1,1),i&2){let t,n=e.column;v((t=n.key)==="mood"?0:t==="actions"?1:2)}}var ee=class i{headApi=E(Q);sentimentApi=E(K);loading=!1;loadingCount=0;errorMessage="";beginLoading(){this.loadingCount++,this.loading=!0}endLoading(){this.loadingCount=Math.max(0,this.loadingCount-1),this.loading=this.loadingCount>0}classesColumns=[{key:"id",label:"ID",sortable:!0,width:"90px"},{key:"className",label:"Class",sortable:!0},{key:"level",label:"Level",sortable:!0,width:"90px",align:"center"},{key:"students",label:"Students",sortable:!0,width:"110px",align:"center"},{key:"teachers",label:"Teachers",sortable:!0,width:"110px",align:"center"},{key:"actions",label:"Actions",sortable:!1,width:"120px",align:"right"}];classesData=[];pagedClassesData=[];classesPagination={page:1,pageSize:5,total:0,pageSizes:[5,10,25,50]};weekdays=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];weekLabel="Week of Nov 10 - Nov 16";upcomingExams=[];activity=[];sentimentColumns=[{key:"student",label:"Student",sortable:!0},{key:"department",label:"Department",sortable:!0},{key:"exam",label:"Exam",sortable:!0},{key:"mood",label:"Mood",sortable:!0,width:"110px",align:"center"},{key:"flagged",label:"Flagged",sortable:!0,width:"120px",align:"center"},{key:"actions",label:"Action",sortable:!1,width:"120px",align:"right"}];sentimentData=[];pagedSentimentData=[];sentimentPagination={page:1,pageSize:5,total:0,pageSizes:[5,10,25,50]};moodColor(e){return e==="High"?"danger":e==="Medium"?"warning":"info"}activityDotClass(e){return`dot dot--${e}`}onClassesPageChange(e){this.classesPagination.page=e,this.updateClassesPaging()}onClassesPageSizeChange(e){this.classesPagination.pageSize=e,this.classesPagination.page=1,this.updateClassesPaging()}updateClassesPaging(){this.classesPagination.total=this.classesData.length;let e=Math.max(1,Math.ceil(this.classesPagination.total/this.classesPagination.pageSize));this.classesPagination.page>e&&(this.classesPagination.page=e),this.classesPagination.page<1&&(this.classesPagination.page=1);let t=(this.classesPagination.page-1)*this.classesPagination.pageSize;this.pagedClassesData=this.classesData.slice(t,t+this.classesPagination.pageSize)}onSentimentPageChange(e){this.sentimentPagination.page=e,this.updateSentimentPaging()}onSentimentPageSizeChange(e){this.sentimentPagination.pageSize=e,this.sentimentPagination.page=1,this.updateSentimentPaging()}updateSentimentPaging(){this.sentimentPagination.total=this.sentimentData.length;let e=Math.max(1,Math.ceil(this.sentimentPagination.total/this.sentimentPagination.pageSize));this.sentimentPagination.page>e&&(this.sentimentPagination.page=e),this.sentimentPagination.page<1&&(this.sentimentPagination.page=1);let t=(this.sentimentPagination.page-1)*this.sentimentPagination.pageSize;this.pagedSentimentData=this.sentimentData.slice(t,t+this.sentimentPagination.pageSize)}academicYears=[];classAcademicYears=[];courses=[];students=[];selectedAcademicYearId="";academicYearOptions(){let e=[{value:"",label:"All academic years"}];for(let t of this.academicYears)e.push({value:String(t.id??""),label:`${t.start.split("-")[0]}\u2013${t.end.split("-")[0]}`});return e}onFilterChanged(){this.loadForAcademicYear(this.selectedAcademicYearId)}async loadAll(){this.beginLoading(),this.errorMessage="";try{this.academicYears=await b(this.headApi.listAcademicYears()),this.selectedAcademicYearId||(this.selectedAcademicYearId=this.pickLatestAcademicYearId(this.academicYears)),await this.loadForAcademicYear(this.selectedAcademicYearId),await this.loadSentimentAlerts()}catch(e){this.errorMessage=e instanceof Error?e.message:"Failed to load dashboard data."}finally{this.endLoading()}}async loadForAcademicYear(e){this.beginLoading(),this.errorMessage="";try{let t=C(e),[n,s,r]=await Promise.all([b(this.headApi.listClasses(t)),b(this.headApi.listCourses(t)),b(this.headApi.listStudents(t))]);this.classAcademicYears=n,this.courses=s,this.students=r,this.recomputeDashboard()}catch(t){this.errorMessage=t instanceof Error?t.message:"Failed to load dashboard data."}finally{this.endLoading()}}mapSentimentToMood(e){if(e.status==="FAILED")return"High";let t=this.getOverallSentiment(e);return t==="NEGATIVE"?"High":t==="MIXED"?"Medium":"Low"}parseResultFromText(e){if(typeof e!="string"||!e.trim())return null;try{let t=JSON.parse(e);return!t||typeof t!="object"?null:t}catch{return null}}getResult(e){return e.resultJson??this.parseResultFromText(e.resultText)}getOverallSentiment(e){return this.getResult(e)?.overallSentiment??null}getConcernsCount(e){let n=this.getResult(e)?.concerns;return Array.isArray(n)?n.length:0}async loadSentimentAlerts(){this.beginLoading();try{let n=(await b(this.sentimentApi.getAll())??[]).filter(a=>!!a?.id).filter(a=>a?.status==="COMPLETED"||a?.status==="FAILED").map(a=>{let m=this.mapSentimentToMood(a),g=this.getConcernsCount(a),O=(m==="High"?3:m==="Medium"?2:1)+(g>0?1:0),x=Date.parse(String(a.analyzedAt??a.createdAt??""));return{a,mood:m,concernsCount:g,score:O,ts:Number.isFinite(x)?x:0}}).sort((a,m)=>m.score-a.score||m.ts-a.ts),s=n.filter(a=>a.mood!=="Low"||a.concernsCount>0||a.a.status==="FAILED"),r=(s.length?s:n).slice(0,10);this.sentimentData=r.map(({a})=>{let m=String(a.courseName??a.quiz?.title??a.quiz?.name??a.quizId??"\u2014"),g=String(a.quiz?.classAcademicYear?.class?.speciality?.name??a.quiz?.department??this.getUser()?.speciality?.name??"\u2014"),O=String(a.quiz?.classAcademicYear?.class?.name??a.quiz?.className??"\u2014"),x=a.analyzedAt?new Date(a.analyzedAt).toLocaleDateString():new Date(a.createdAt).toLocaleDateString();return{student:O,department:g,exam:m,mood:this.mapSentimentToMood(a),flagged:x}}),this.sentimentPagination.page=1,this.updateSentimentPaging()}catch{this.sentimentData=[],this.sentimentPagination.page=1,this.updateSentimentPaging()}finally{this.endLoading()}}pickLatestAcademicYearId(e){let t=s=>{if(typeof s!="string")return Number.NEGATIVE_INFINITY;let r=Date.parse(s);return Number.isFinite(r)?r:Number.NEGATIVE_INFINITY},n=e.filter(s=>!!s?.id).map(s=>{let r=t(s.end),a=t(s.start);return{ay:s,score:r!==Number.NEGATIVE_INFINITY?r:a}}).sort((s,r)=>r.score-s.score)[0]?.ay;return String(n?.id??"")}getUser(){return JSON.parse(localStorage.getItem("currentUser")||"{}")}recomputeDashboard(){let e=C(this.selectedAcademicYearId),t=this.getUser()?.speciality?.name,n=this.classAcademicYears.filter(a=>{if(e&&C(a.academicYear?.id)!==e)return!1;let g=a.class?.speciality?.name;return!(t&&g&&g!==t)}),s=this.courses.filter(a=>{if(e&&C(a.classAcademicYear?.academicYear?.id)!==e)return!1;let g=a.classAcademicYear?.class?.speciality?.name;return!(t&&g&&g!==t)});this.classesData=this.buildClassesOverview(n,s),this.classesPagination.page=1,this.updateClassesPaging();let r=new Set;for(let a of s){let m=a.teacher?.id;m&&r.add(m)}this.stats={classesManaged:n.length,students:(this.students??[]).length,teachers:r.size,upcomingExams:this.upcomingExams.length}}buildClassesOverview(e,t){let n=new Map;for(let r of e){if(!r?.id)continue;let a=r.class;a?.name&&n.set(r.id,{id:a.id??r.id,className:a.name,level:Number(a.level)||0,students:0,teachers:0})}let s=new Map;for(let r of t){let a=r.classAcademicYear?.id,m=r.teacher?.id;if(!a||!m)continue;let g=s.get(a)??new Set;g.add(m),s.set(a,g)}for(let[r,a]of n.entries())a.teachers=s.get(r)?.size??0;return Array.from(n.values()).sort((r,a)=>r.className.localeCompare(a.className))}stats={classesManaged:0,students:0,teachers:0,upcomingExams:0};ngOnInit(){this.activity=Z(),this.loadAll()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=T({type:i,selectors:[["app-head-dashboard"]],decls:56,vars:22,consts:[["cell",""],["empty",""],[1,"dashboard"],[1,"dashboard__header"],[1,"dashboard__title-section"],[1,"dashboard__title"],[1,"dashboard__subtitle"],["label","Scope",3,"ngModelChange","options","ngModel","searchable"],[1,"dashboard__loading"],["type","danger","variant","outlined"],[1,"dashboard__stats"],["label","Classes Managed","color","primary","icon","class","format","number",3,"value"],["label","Students","color","accent","icon","star","format","number",3,"value"],["label","Teachers","color","info","icon","groups","format","number",3,"value"],["label","Upcoming Exams","color","warning","icon","warning","format","number",3,"value"],[1,"dashboard__grid"],["variant","outlined",1,"panel"],[1,"panel__header"],[1,"panel__title"],[1,"panel__subtitle"],[3,"pageChange","pageSizeChange","columns","data","loading","searchable","showPagination","pagination"],[1,"calendar-header"],[1,"calendar-weekdays"],[1,"weekday"],[1,"exams-list"],[1,"exam-item",3,"class"],[1,"dashboard__grid","dashboard__grid--bottom"],[1,"activity-list"],[1,"activity-item"],["emptyMessage","",3,"pageChange","pageSizeChange","columns","data","loading","searchable","showPagination","pagination"],["size","md","color","primary","label","Loading dashboard...",3,"showLabel"],[1,"table-actions"],["size","sm","variant","soft","color","primary"],[1,"exam-item"],[1,"exam-name"],[1,"exam-time"],[1,"activity-item__content"],[1,"activity-item__message"],[1,"activity-item__time"],[1,"table-empty"],["variant","subtle",3,"color"]],template:function(t,n){if(t&1){let s=Y();o(0,"div",2)(1,"header",3)(2,"div",4)(3,"h1",5),c(4,"Dashboard Overview"),l(),o(5,"p",6),c(6,"Monitor classes, students and teachers"),l()(),o(7,"ui-select",7),R("ngModelChange",function(a){return h(s),H(n.selectedAcademicYearId,a)||(n.selectedAcademicYearId=a),_(a)}),M("ngModelChange",function(){return h(s),_(n.onFilterChanged())}),l()(),y(8,ne,2,1,"div",8),y(9,ie,2,1,"ui-alert",9),o(10,"section",10),P(11,"ui-stat-card",11)(12,"ui-stat-card",12)(13,"ui-stat-card",13)(14,"ui-stat-card",14),l(),o(15,"section",15)(16,"ui-card",16)(17,"div",17)(18,"div",18),c(19,"Classes Overview"),l(),o(20,"div",19),c(21,"Teacher/class assignments are completed by specialty heads."),l()(),o(22,"ui-table",20),M("pageChange",function(a){return h(s),_(n.onClassesPageChange(a))})("pageSizeChange",function(a){return h(s),_(n.onClassesPageSizeChange(a))}),I(23,oe,2,1,"ng-template",null,0,D),l()(),o(25,"ui-card",16)(26,"div",17)(27,"div",18),c(28,"Upcoming Exams"),l()(),o(29,"div",21),c(30),l(),o(31,"div",22),S(32,le,2,1,"div",23,z),l(),o(34,"div",24),S(35,de,5,4,"div",25,te),l()()(),o(37,"section",26)(38,"ui-card",16)(39,"div",17)(40,"div",18),c(41,"Recent Activity"),l()(),o(42,"div",27),S(43,ce,7,4,"div",28,ae),l()(),o(45,"ui-card",16)(46,"div",17)(47,"div",18),c(48,"Critical Sentiment Alerts"),l(),o(49,"div",19),c(50,"Essays flagged for immediate counselor review"),l()(),o(51,"ui-table",29),M("pageChange",function(a){return h(s),_(n.onSentimentPageChange(a))})("pageSizeChange",function(a){return h(s),_(n.onSentimentPageSizeChange(a))}),I(52,me,2,0,"ng-template",null,1,D)(54,he,3,1,"ng-template",null,0,D),l()()()()}t&2&&(d(7),p("options",n.academicYearOptions()),N("ngModel",n.selectedAcademicYearId),p("searchable",!0),d(),v(n.loading?8:-1),d(),v(n.errorMessage?9:-1),d(2),p("value",n.stats.classesManaged),d(),p("value",n.stats.students),d(),p("value",n.stats.teachers),d(),p("value",n.stats.upcomingExams),d(8),p("columns",n.classesColumns)("data",n.pagedClassesData)("loading",n.loading)("searchable",!0)("showPagination",!0)("pagination",n.classesPagination),d(8),u(n.weekLabel),d(2),w(n.weekdays),d(3),w(n.upcomingExams),d(8),w(n.activity),d(8),p("columns",n.sentimentColumns)("data",n.pagedSentimentData)("loading",n.loading)("searchable",!0)("showPagination",!0)("pagination",n.sentimentPagination))},dependencies:[L,U,F,V,B,W,J,$,q,j,G,X],styles:[".dashboard[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.25rem;padding:.5rem}.dashboard__header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;flex-wrap:wrap}.dashboard__loading[_ngcontent-%COMP%]{display:flex;justify-content:center;padding:.25rem 0}.dashboard__title-section[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.dashboard__title[_ngcontent-%COMP%]{font-size:1.75rem;font-weight:700;color:var(--text-primary);margin:0}.dashboard__subtitle[_ngcontent-%COMP%]{font-size:.875rem;color:var(--text-tertiary);margin:0}.dashboard__stats[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}@media (max-width: 1100px){.dashboard__stats[_ngcontent-%COMP%]{grid-template-columns:repeat(2,1fr)}}@media (max-width: 600px){.dashboard__stats[_ngcontent-%COMP%]{grid-template-columns:1fr}}.dashboard__grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:1rem;align-items:start}@media (max-width: 1100px){.dashboard__grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}.dashboard__grid--bottom[_ngcontent-%COMP%]{grid-template-columns:1fr 1fr}@media (max-width: 1100px){.dashboard__grid--bottom[_ngcontent-%COMP%]{grid-template-columns:1fr}}.panel[_ngcontent-%COMP%]{width:100%}.panel__header[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem;padding:.25rem 0 1rem}.panel__title[_ngcontent-%COMP%]{font-size:1rem;font-weight:700;color:var(--text-primary)}.panel__subtitle[_ngcontent-%COMP%]{font-size:.8125rem;color:var(--text-tertiary)}.table-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end}.table-empty[_ngcontent-%COMP%]{padding:1rem 0;color:var(--text-tertiary);font-size:.875rem}.calendar-header[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-tertiary);margin-bottom:.75rem}.calendar-weekdays[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(7,1fr);gap:.5rem;margin-bottom:.75rem}.weekday[_ngcontent-%COMP%]{text-align:center;font-size:.75rem;color:var(--text-tertiary)}.exams-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.exam-item[_ngcontent-%COMP%]{padding:.75rem;border-radius:10px;border:1px solid var(--border-subtle)}.exam-item--info[_ngcontent-%COMP%]{background:var(--surface-info);border-color:var(--color-info-border)}.exam-item--success[_ngcontent-%COMP%]{background:var(--surface-success);border-color:var(--color-success-border)}.exam-item--warning[_ngcontent-%COMP%]{background:var(--surface-warning);border-color:var(--color-warning-border)}.exam-item--danger[_ngcontent-%COMP%]{background:var(--surface-danger);border-color:var(--color-danger-border)}.exam-name[_ngcontent-%COMP%]{font-size:.875rem;font-weight:700;color:var(--text-primary)}.exam-time[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-tertiary);margin-top:.25rem}.activity-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem}.activity-item[_ngcontent-%COMP%]{display:flex;gap:.75rem;align-items:flex-start}.activity-item__content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.activity-item__message[_ngcontent-%COMP%]{font-size:.875rem;color:var(--text-primary)}.activity-item__time[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-tertiary)}.dot[_ngcontent-%COMP%]{width:10px;height:10px;border-radius:999px;margin-top:.35rem;flex:0 0 10px}.dot--info[_ngcontent-%COMP%]{background:var(--color-info)}.dot--success[_ngcontent-%COMP%]{background:var(--color-success)}.dot--warning[_ngcontent-%COMP%]{background:var(--color-warning)}.dot--danger[_ngcontent-%COMP%]{background:var(--color-danger)}.dot--primary[_ngcontent-%COMP%]{background:var(--color-primary)}.dot--neutral[_ngcontent-%COMP%]{background:var(--text-tertiary)}.dot--secondary[_ngcontent-%COMP%]{background:var(--color-secondary)}.dot--accent[_ngcontent-%COMP%]{background:var(--color-accent)}"]})};export{ee as HeadDashboard};
