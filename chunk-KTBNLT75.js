import{a as m}from"./chunk-MSJ3XUEL.js";import{a as y}from"./chunk-FWCO3CJY.js";import{F as S,P as u,U as v,Y as c,a as o,h as i,i as a,q as p,x as l,y as h,z as d}from"./chunk-3XB4H34J.js";var b=class s{constructor(e,t){this.config=e;this.authStore=t}eventSource=null;destroy$=new i;reconnectAttempts=0;lastOptions={reconnectDelayMs:3e3,maxReconnectAttempts:10};eventsSubject=new i;events$=this.eventsSubject.asObservable();connectionStateSubject=new a("disconnected");connectionState$=this.connectionStateSubject.asObservable();connect(e={}){this.disconnect(),this.lastOptions=o(o({},this.lastOptions),e),this.establishConnection()}disconnect(){this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.connectionStateSubject.next("disconnected"),this.reconnectAttempts=0}on(...e){return this.events$.pipe(d(t=>e.includes(t.type)),p(t=>t))}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.disconnect()}establishConnection(){let e=this.authStore.getAccessToken();if(!e){this.connectionStateSubject.next("error");return}this.connectionStateSubject.next("connecting");let t=this.buildUrl(e);try{this.eventSource=new EventSource(t),this.eventSource.onopen=()=>{this.connectionStateSubject.next("connected"),this.reconnectAttempts=0},this.eventSource.onerror=()=>{this.connectionStateSubject.next("error"),this.scheduleReconnect()},this.eventSource.onmessage=n=>this.handleMessage(n),new Set(["connected","heartbeat",...this.lastOptions.eventTypes??[]]).forEach(n=>{this.eventSource?.addEventListener(n,A=>{this.handleMessage(A)})}),h(l(0)).pipe(u(this.destroy$),S(()=>{})).subscribe()}catch{this.connectionStateSubject.next("error"),this.scheduleReconnect()}}buildUrl(e){let r=`${this.config.apiBaseUrl.replace(/\/$/,"")}/events/sse`,n=new URLSearchParams;return n.set("token",e),this.lastOptions.rooms?.length&&n.set("rooms",this.lastOptions.rooms.join(",")),this.lastOptions.eventTypes?.length&&n.set("types",this.lastOptions.eventTypes.join(",")),`${r}?${n.toString()}`}handleMessage(e){try{let t=JSON.parse(e.data);this.eventsSubject.next(t)}catch{}}scheduleReconnect(){if(this.disconnect(),this.reconnectAttempts>=this.lastOptions.maxReconnectAttempts)return;this.reconnectAttempts++;let e=this.lastOptions.reconnectDelayMs;setTimeout(()=>this.establishConnection(),e)}static \u0275fac=function(t){return new(t||s)(c(y),c(m))};static \u0275prov=v({token:s,factory:s.\u0275fac,providedIn:"root"})};export{b as a};
