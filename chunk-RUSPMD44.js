import{a as $,b as J}from"./chunk-BT74ICIE.js";import{a as B}from"./chunk-ORD7MMJC.js";import{a as f}from"./chunk-O6YQIL4L.js";import{f as V,j as G,n as j}from"./chunk-AO6LNOWB.js";import{a as q}from"./chunk-SJBCNNOS.js";import{a as F,b as U}from"./chunk-2WUHN5CQ.js";import"./chunk-MAWX5T35.js";import{c as H,f as L,n as R,u as W}from"./chunk-XGVRFAFZ.js";import"./chunk-4BWE2P25.js";import"./chunk-LUIYB3PI.js";import"./chunk-LM6INHLT.js";import{$a as g,Ab as w,Db as z,Eb as Y,Fb as k,Ka as S,Oa as A,Pb as T,Va as b,Wa as y,Z as P,Za as D,_a as O,ab as o,ba as h,bb as d,ca as _,cb as v,jb as I,lb as x,nb as C,p as u,rc as N,xb as E,yb as c,za as l,zb as M}from"./chunk-3XB4H34J.js";var K=(r,t)=>t.message;function Q(r,t){r&1&&(o(0,"div",7),v(1,"ui-spinner",22),d()),r&2&&(l(),g("showLabel",!0))}function Z(r,t){if(r&1&&(o(0,"ui-alert",8),c(1),d()),r&2){let a=C();l(),w(" ",a.errorMessage," ")}}function ee(r,t){r&1&&(o(0,"div",23)(1,"ui-button",24),c(2,"View"),d()())}function te(r,t){if(r&1&&c(0),r&2){let a=C(),e=a.$implicit,i=a.column;w(" ",e[i.key]," ")}}function ae(r,t){if(r&1&&b(0,ee,3,0,"div",23)(1,te,1,1),r&2){let a,e=t.column;y((a=e.key)==="actions"?0:1)}}function ne(r,t){if(r&1&&(o(0,"div",21),v(1,"span"),o(2,"div",25)(3,"div",26),c(4),d(),o(5,"div",27),c(6),d()()()),r&2){let a=t.$implicit,e=C();l(),E(e.activityDotClass(a.tone)),l(3),M(a.message),l(2),M(a.timeAgo)}}var X=class r{headApi=P($);sentimentApi=P(B);loading=!1;loadingCount=0;errorMessage="";beginLoading(){this.loadingCount++,this.loading=!0}endLoading(){this.loadingCount=Math.max(0,this.loadingCount-1),this.loading=this.loadingCount>0}classesColumns=[{key:"id",label:"ID",sortable:!0,width:"90px"},{key:"className",label:"Class",sortable:!0},{key:"level",label:"Level",sortable:!0,width:"90px",align:"center"},{key:"students",label:"Students",sortable:!0,width:"110px",align:"center"},{key:"teachers",label:"Teachers",sortable:!0,width:"110px",align:"center"},{key:"actions",label:"Actions",sortable:!1,width:"120px",align:"right"}];classesData=[];pagedClassesData=[];classesPagination={page:1,pageSize:5,total:0,pageSizes:[5,10,25,50]};weekdays=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];weekLabel="Week of Nov 10 - Nov 16";upcomingExams=[];activity=[];sentimentColumns=[{key:"student",label:"Student",sortable:!0},{key:"department",label:"Department",sortable:!0},{key:"exam",label:"Exam",sortable:!0},{key:"mood",label:"Mood",sortable:!0,width:"110px",align:"center"},{key:"flagged",label:"Flagged",sortable:!0,width:"120px",align:"center"},{key:"actions",label:"Action",sortable:!1,width:"120px",align:"right"}];sentimentData=[];pagedSentimentData=[];sentimentPagination={page:1,pageSize:5,total:0,pageSizes:[5,10,25,50]};moodColor(t){return t==="High"?"danger":t==="Medium"?"warning":"info"}activityDotClass(t){return`dot dot--${t}`}onClassesPageChange(t){this.classesPagination.page=t,this.updateClassesPaging()}onClassesPageSizeChange(t){this.classesPagination.pageSize=t,this.classesPagination.page=1,this.updateClassesPaging()}updateClassesPaging(){this.classesPagination.total=this.classesData.length;let t=Math.max(1,Math.ceil(this.classesPagination.total/this.classesPagination.pageSize));this.classesPagination.page>t&&(this.classesPagination.page=t),this.classesPagination.page<1&&(this.classesPagination.page=1);let a=(this.classesPagination.page-1)*this.classesPagination.pageSize;this.pagedClassesData=this.classesData.slice(a,a+this.classesPagination.pageSize)}onSentimentPageChange(t){this.sentimentPagination.page=t,this.updateSentimentPaging()}onSentimentPageSizeChange(t){this.sentimentPagination.pageSize=t,this.sentimentPagination.page=1,this.updateSentimentPaging()}updateSentimentPaging(){this.sentimentPagination.total=this.sentimentData.length;let t=Math.max(1,Math.ceil(this.sentimentPagination.total/this.sentimentPagination.pageSize));this.sentimentPagination.page>t&&(this.sentimentPagination.page=t),this.sentimentPagination.page<1&&(this.sentimentPagination.page=1);let a=(this.sentimentPagination.page-1)*this.sentimentPagination.pageSize;this.pagedSentimentData=this.sentimentData.slice(a,a+this.sentimentPagination.pageSize)}academicYears=[];classAcademicYears=[];courses=[];students=[];selectedAcademicYearId="";academicYearOptions(){let t=[{value:"",label:"All academic years"}];for(let a of this.academicYears)t.push({value:String(a.id??""),label:`${a.start.split("-")[0]}\u2013${a.end.split("-")[0]}`});return t}onFilterChanged(){this.loadForAcademicYear(this.selectedAcademicYearId)}async loadAll(){this.beginLoading(),this.errorMessage="";try{this.academicYears=await u(this.headApi.listAcademicYears()),this.selectedAcademicYearId||(this.selectedAcademicYearId=this.pickLatestAcademicYearId(this.academicYears)),await this.loadForAcademicYear(this.selectedAcademicYearId),await this.loadSentimentAlerts()}catch(t){this.errorMessage=t instanceof Error?t.message:"Failed to load dashboard data."}finally{this.endLoading()}}async loadForAcademicYear(t){this.beginLoading(),this.errorMessage="";try{let a=f(t),[e,i,s]=await Promise.all([u(this.headApi.listClasses(a)),u(this.headApi.listCourses(a)),u(this.headApi.listStudents(a))]);this.classAcademicYears=e,this.courses=i,this.students=s,this.recomputeDashboard()}catch(a){this.errorMessage=a instanceof Error?a.message:"Failed to load dashboard data."}finally{this.endLoading()}}mapSentimentToMood(t){let a=t.resultJson?.overallSentiment;return a==="NEGATIVE"?"High":a==="MIXED"?"Medium":"Low"}async loadSentimentAlerts(){this.beginLoading();try{let a=(await u(this.sentimentApi.getAll())??[]).filter(e=>e?.status==="COMPLETED").filter(e=>{let i=e.resultJson?.overallSentiment;return i==="NEGATIVE"||i==="MIXED"}).slice(0,10);this.sentimentData=a.map(e=>{let i=String(e.courseName??e.quiz?.title??e.quiz?.name??e.quizId??"\u2014"),s=String(e.quiz?.classAcademicYear?.class?.speciality?.name??e.quiz?.department??this.getUser()?.speciality?.name??"\u2014"),n=String(e.quiz?.classAcademicYear?.class?.name??e.quiz?.className??"\u2014"),m=e.analyzedAt?new Date(e.analyzedAt).toLocaleDateString():new Date(e.createdAt).toLocaleDateString();return{student:n,department:s,exam:i,mood:this.mapSentimentToMood(e),flagged:m}}),this.sentimentPagination.page=1,this.updateSentimentPaging()}catch{this.sentimentData=[],this.sentimentPagination.page=1,this.updateSentimentPaging()}finally{this.endLoading()}}pickLatestAcademicYearId(t){let a=i=>{if(typeof i!="string")return Number.NEGATIVE_INFINITY;let s=Date.parse(i);return Number.isFinite(s)?s:Number.NEGATIVE_INFINITY},e=t.filter(i=>!!i?.id).map(i=>{let s=a(i.end),n=a(i.start);return{ay:i,score:s!==Number.NEGATIVE_INFINITY?s:n}}).sort((i,s)=>s.score-i.score)[0]?.ay;return String(e?.id??"")}getUser(){return JSON.parse(localStorage.getItem("currentUser")||"{}")}recomputeDashboard(){let t=f(this.selectedAcademicYearId),a=this.getUser()?.speciality?.name,e=this.classAcademicYears.filter(n=>{if(t&&f(n.academicYear?.id)!==t)return!1;let p=n.class?.speciality?.name;return!(a&&p&&p!==a)}),i=this.courses.filter(n=>{if(t&&f(n.classAcademicYear?.academicYear?.id)!==t)return!1;let p=n.classAcademicYear?.class?.speciality?.name;return!(a&&p&&p!==a)});this.classesData=this.buildClassesOverview(e,i),this.classesPagination.page=1,this.updateClassesPaging();let s=new Set;for(let n of i){let m=n.teacher?.id;m&&s.add(m)}this.stats={classesManaged:e.length,students:(this.students??[]).length,teachers:s.size,upcomingExams:this.upcomingExams.length}}buildClassesOverview(t,a){let e=new Map;for(let s of t){if(!s?.id)continue;let n=s.class;n?.name&&e.set(s.id,{id:n.id??s.id,className:n.name,level:Number(n.level)||0,students:0,teachers:0})}let i=new Map;for(let s of a){let n=s.classAcademicYear?.id,m=s.teacher?.id;if(!n||!m)continue;let p=i.get(n)??new Set;p.add(m),i.set(n,p)}for(let[s,n]of e.entries())n.teachers=i.get(s)?.size??0;return Array.from(e.values()).sort((s,n)=>s.className.localeCompare(n.className))}stats={classesManaged:0,students:0,teachers:0,upcomingExams:0};ngOnInit(){this.activity=J(),this.loadAll()}static \u0275fac=function(a){return new(a||r)};static \u0275cmp=S({type:r,selectors:[["app-head-dashboard"]],decls:32,vars:15,consts:[["cell",""],[1,"dashboard"],[1,"dashboard__header"],[1,"dashboard__title-section"],[1,"dashboard__title"],[1,"dashboard__subtitle"],["label","Scope",3,"ngModelChange","options","ngModel","searchable"],[1,"dashboard__loading"],["type","danger","variant","outlined"],[1,"dashboard__stats"],["label","Classes Managed","color","primary","icon","class","format","number",3,"value"],["label","Students","color","accent","icon","star","format","number",3,"value"],["label","Teachers","color","info","icon","groups","format","number",3,"value"],["label","Upcoming Exams","color","warning","icon","warning","format","number",3,"value"],[1,"dashboard__grid"],["variant","outlined",1,"panel"],[1,"panel__header"],[1,"panel__title"],[1,"panel__subtitle"],[3,"pageChange","pageSizeChange","columns","data","loading","searchable","showPagination","pagination"],[1,"activity-list"],[1,"activity-item"],["size","md","color","primary","label","Loading dashboard...",3,"showLabel"],[1,"table-actions"],["size","sm","variant","soft","color","primary"],[1,"activity-item__content"],[1,"activity-item__message"],[1,"activity-item__time"]],template:function(a,e){if(a&1){let i=I();o(0,"div",1)(1,"header",2)(2,"div",3)(3,"h1",4),c(4,"Dashboard Overview"),d(),o(5,"p",5),c(6,"Monitor classes, students and teachers"),d()(),o(7,"ui-select",6),k("ngModelChange",function(n){return h(i),Y(e.selectedAcademicYearId,n)||(e.selectedAcademicYearId=n),_(n)}),x("ngModelChange",function(){return h(i),_(e.onFilterChanged())}),d()(),b(8,Q,2,1,"div",7),b(9,Z,2,1,"ui-alert",8),o(10,"section",9),v(11,"ui-stat-card",10)(12,"ui-stat-card",11)(13,"ui-stat-card",12)(14,"ui-stat-card",13),d(),o(15,"section",14)(16,"ui-card",15)(17,"div",16)(18,"div",17),c(19,"Classes Overview"),d(),o(20,"div",18),c(21,"Teacher/class assignments are completed by specialty heads."),d()(),o(22,"ui-table",19),x("pageChange",function(n){return h(i),_(e.onClassesPageChange(n))})("pageSizeChange",function(n){return h(i),_(e.onClassesPageSizeChange(n))}),A(23,ae,2,1,"ng-template",null,0,T),d()(),o(25,"ui-card",15)(26,"div",16)(27,"div",17),c(28,"Recent Activity"),d()(),o(29,"div",20),D(30,ne,7,4,"div",21,K),d()()()()}a&2&&(l(7),g("options",e.academicYearOptions()),z("ngModel",e.selectedAcademicYearId),g("searchable",!0),l(),y(e.loading?8:-1),l(),y(e.errorMessage?9:-1),l(2),g("value",e.stats.classesManaged),l(),g("value",e.stats.students),l(),g("value",e.stats.teachers),l(),g("value",e.stats.upcomingExams),l(8),g("columns",e.classesColumns)("data",e.pagedClassesData)("loading",e.loading)("searchable",!0)("showPagination",!0)("pagination",e.classesPagination),l(8),O(e.activity))},dependencies:[N,R,H,L,U,q,W,F,V,G,j],styles:[".dashboard[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.25rem;padding:.5rem}.dashboard__header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;flex-wrap:wrap}.dashboard__loading[_ngcontent-%COMP%]{display:flex;justify-content:center;padding:.25rem 0}.dashboard__title-section[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.dashboard__title[_ngcontent-%COMP%]{font-size:1.75rem;font-weight:700;color:var(--text-primary);margin:0}.dashboard__subtitle[_ngcontent-%COMP%]{font-size:.875rem;color:var(--text-tertiary);margin:0}.dashboard__stats[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}@media (max-width: 1100px){.dashboard__stats[_ngcontent-%COMP%]{grid-template-columns:repeat(2,1fr)}}@media (max-width: 600px){.dashboard__stats[_ngcontent-%COMP%]{grid-template-columns:1fr}}.dashboard__grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:1rem;align-items:start}@media (max-width: 1100px){.dashboard__grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}.dashboard__grid--bottom[_ngcontent-%COMP%]{grid-template-columns:1fr 1fr}@media (max-width: 1100px){.dashboard__grid--bottom[_ngcontent-%COMP%]{grid-template-columns:1fr}}.panel[_ngcontent-%COMP%]{width:100%}.panel__header[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem;padding:.25rem 0 1rem}.panel__title[_ngcontent-%COMP%]{font-size:1rem;font-weight:700;color:var(--text-primary)}.panel__subtitle[_ngcontent-%COMP%]{font-size:.8125rem;color:var(--text-tertiary)}.table-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end}.table-empty[_ngcontent-%COMP%]{padding:1rem 0;color:var(--text-tertiary);font-size:.875rem}.calendar-header[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-tertiary);margin-bottom:.75rem}.calendar-weekdays[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(7,1fr);gap:.5rem;margin-bottom:.75rem}.weekday[_ngcontent-%COMP%]{text-align:center;font-size:.75rem;color:var(--text-tertiary)}.exams-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.exam-item[_ngcontent-%COMP%]{padding:.75rem;border-radius:10px;border:1px solid var(--border-subtle)}.exam-item--info[_ngcontent-%COMP%]{background:var(--surface-info);border-color:var(--color-info-border)}.exam-item--success[_ngcontent-%COMP%]{background:var(--surface-success);border-color:var(--color-success-border)}.exam-item--warning[_ngcontent-%COMP%]{background:var(--surface-warning);border-color:var(--color-warning-border)}.exam-item--danger[_ngcontent-%COMP%]{background:var(--surface-danger);border-color:var(--color-danger-border)}.exam-name[_ngcontent-%COMP%]{font-size:.875rem;font-weight:700;color:var(--text-primary)}.exam-time[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-tertiary);margin-top:.25rem}.activity-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem}.activity-item[_ngcontent-%COMP%]{display:flex;gap:.75rem;align-items:flex-start}.activity-item__content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.activity-item__message[_ngcontent-%COMP%]{font-size:.875rem;color:var(--text-primary)}.activity-item__time[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-tertiary)}.dot[_ngcontent-%COMP%]{width:10px;height:10px;border-radius:999px;margin-top:.35rem;flex:0 0 10px}.dot--info[_ngcontent-%COMP%]{background:var(--color-info)}.dot--success[_ngcontent-%COMP%]{background:var(--color-success)}.dot--warning[_ngcontent-%COMP%]{background:var(--color-warning)}.dot--danger[_ngcontent-%COMP%]{background:var(--color-danger)}.dot--primary[_ngcontent-%COMP%]{background:var(--color-primary)}.dot--neutral[_ngcontent-%COMP%]{background:var(--text-tertiary)}.dot--secondary[_ngcontent-%COMP%]{background:var(--color-secondary)}.dot--accent[_ngcontent-%COMP%]{background:var(--color-accent)}"]})};export{X as HeadDashboard};
